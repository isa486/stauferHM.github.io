<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Historial de Máquina</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>Detalles del Historial de la Máquina</h1>
  </header>
  <main>
    <div id="nombre-maquina"></div>
    <div id="tabs-mantenimientos"></div>
    <section id="detalle-mantenimiento"></section>
  </main>
  <footer>
    <small>&copy; 2025 Tu Empresa</small>
  </footer>
  <script>
    // Obtener parámetros de la URL
    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    // Cargar los datos de la máquina (nombre, QR)
    function cargarDatosMaquina(idMaquina) {
      return fetch('data/maquinas.json')
        .then(res => res.json())
        .then(maquinas => maquinas.find(m => m.id === idMaquina));
    }

    // Cargar historial de mantenimientos de la máquina
    function cargarHistorialMantenimientos(idMaquina) {
      return fetch(`data/historiales/${idMaquina}.json`)
        .then(res => res.json());
    }

    function renderHistorial() {
      const idMaquina = getQueryParam('id');
      if (!idMaquina) return;

      Promise.all([
        cargarDatosMaquina(idMaquina),
        cargarHistorialMantenimientos(idMaquina)
      ])
      .then(([maquina, mantenimientos]) => {
        // Mostrar nombre de la máquina y su QR
        document.getElementById('nombre-maquina').innerHTML =
          maquina
            ? `<h2>${maquina.nombre}</h2>${maquina.qr ? `<img src="qr/${maquina.qr}" alt="QR" class="qr-img">` : ''}`
            : "<h2>Máquina no encontrada</h2>";

        if (!Array.isArray(mantenimientos) || mantenimientos.length === 0) {
          document.getElementById('detalle-mantenimiento').innerHTML = '<p>No hay mantenimientos registrados para esta máquina.</p>';
          document.getElementById('tabs-mantenimientos').innerHTML = '';
          return;
        }

        // Renderizar pestañas
        const tabsDiv = document.getElementById('tabs-mantenimientos');
        tabsDiv.innerHTML = '';
        mantenimientos.forEach((mtto, idx) => {
          tabsDiv.innerHTML += `<button class="tab-mtto" data-idx="${idx}" ${idx === 0 ? "style='font-weight:bold'" : ""}>${mtto.fecha} - ${mtto.trabajo}</button>`;
        });

        function mostrarDetalle(idx) {
          const mtto = mantenimientos[idx];
          let html = `
            <h3>Mantenimiento del ${mtto.fecha}</h3>
            <table>
              <tr><td><strong>Trabajo:</strong> ${mtto.trabajo || ''}</td></tr>
              <tr><td><strong>Empresa:</strong> ${mtto.empresa || ''}</td></tr>
              <tr><td><strong>Contacto:</strong> ${mtto.contacto || ''}</td></tr>
              <tr><td><strong>Ubicación:</strong> ${mtto.ubicacion || ''}</td></tr>
              ${mtto.tel ? `<tr><td><strong>Tel:</strong> ${mtto.tel}</td></tr>` : ''}
              ${mtto.estado ? `<tr><td><strong>Estado:</strong> ${mtto.estado}</td></tr>` : ''}
              ${mtto.puesto ? `<tr><td><strong>Puesto:</strong> ${mtto.puesto}</td></tr>` : ''}
              ${mtto.fecha_compra ? `<tr><td><strong>Fecha de compra:</strong> ${mtto.fecha_compra}</td></tr>` : ''}
              ${mtto.quien_realiza ? `<tr><td><strong>Quién realiza:</strong> ${mtto.quien_realiza}</td></tr>` : ''}
              ${mtto.fecha_instalacion ? `<tr><td><strong>Fecha instalación:</strong> ${mtto.fecha_instalacion}</td></tr>` : ''}
              ${mtto.modelo ? `<tr><td><strong>Modelo:</strong> ${mtto.modelo}</td></tr>` : ''}
              ${mtto.tipo ? `<tr><td><strong>Tipo:</strong> ${mtto.tipo}</td></tr>` : ''}
              ${mtto.serie ? `<tr><td><strong>No. Serie:</strong> ${mtto.serie}</td></tr>` : ''}
              ${mtto.temp_max ? `<tr><td><strong>Temp. máx:</strong> ${mtto.temp_max}</td></tr>` : ''}
              ${mtto.fase ? `<tr><td><strong>Fase motor:</strong> ${mtto.fase}</td></tr>` : ''}
              ${mtto.voltios ? `<tr><td><strong>Voltios:</strong> ${mtto.voltios}</td></tr>` : ''}
              ${mtto.amperaje ? `<tr><td><strong>Amperaje máx:</strong> ${mtto.amperaje}</td></tr>` : ''}
            </table>
            ${mtto.lecturas ? `
            <h4>Lecturas</h4>
            <table>
              ${mtto.lecturas.toma_corriente ? `<tr><td><strong>Toma corriente:</strong> ${mtto.lecturas.toma_corriente}</td></tr>` : ''}
              ${mtto.lecturas.rampeo_corriente ? `<tr><td><strong>Rampeo corriente:</strong> ${mtto.lecturas.rampeo_corriente}</td></tr>` : ''}
              ${mtto.lecturas.entrada ? `<tr><td><strong>Entrada:</strong> ${mtto.lecturas.entrada}</td></tr>` : ''}
              ${mtto.lecturas.rampeo_entrada ? `<tr><td><strong>Rampeo entrada:</strong> ${mtto.lecturas.rampeo_entrada}</td></tr>` : ''}
              ${mtto.lecturas.salida ? `<tr><td><strong>Salida:</strong> ${mtto.lecturas.salida}</td></tr>` : ''}
              ${mtto.lecturas.rampeo_salida ? `<tr><td><strong>Rampeo salida:</strong> ${mtto.lecturas.rampeo_salida}</td></tr>` : ''}
              ${mtto.lecturas.amperaje ? `<tr><td><strong>Amperaje:</strong> ${mtto.lecturas.amperaje}</td></tr>` : ''}
              ${mtto.lecturas.rampeo_amperaje ? `<tr><td><strong>Rampeo amperaje:</strong> ${mtto.lecturas.rampeo_amperaje}</td></tr>` : ''}
              ${mtto.lecturas.presion ? `<tr><td><strong>Presión:</strong> ${mtto.lecturas.presion}</td></tr>` : ''}
              ${mtto.lecturas.rampeo_presion ? `<tr><td><strong>Rampeo presión:</strong> ${mtto.lecturas.rampeo_presion}</td></tr>` : ''}
              ${mtto.lecturas.aceite ? `<tr><td><strong>Aceite:</strong> ${mtto.lecturas.aceite}</td></tr>` : ''}
              ${mtto.lecturas.rampeo_aceite ? `<tr><td><strong>Rampeo aceite:</strong> ${mtto.lecturas.rampeo_aceite}</td></tr>` : ''}
              ${mtto.lecturas.temperatura ? `<tr><td><strong>Temperatura:</strong> ${mtto.lecturas.temperatura}</td></tr>` : ''}
              ${mtto.lecturas.rampeo_temperatura ? `<tr><td><strong>Rampeo temperatura:</strong> ${mtto.lecturas.rampeo_temperatura}</td></tr>` : ''}
            </table>
            ` : ''}
            ${mtto.material_utilizado ? `<h4>Material utilizado</h4><p>${mtto.material_utilizado}</p>` : ''}
            <h4>Comentarios</h4>
            <p>${mtto.comentarios || ''}</p>
            <p><strong>Realizó:</strong> ${mtto.realizo || ''} &nbsp; <strong>Recibió:</strong> ${mtto.recibio || ''}</p>
            <div class="acciones-historial">
              <button onclick="window.print()">Imprimir historial</button>
              <button onclick="window.location.href='maquinas-listado.html'">Volver al listado</button>
            </div>
          `;
          document.getElementById('detalle-mantenimiento').innerHTML = html;
          // Resalta la pestaña activa
          document.querySelectorAll('.tab-mtto').forEach((btn, i) => {
            btn.style.fontWeight = i === idx ? 'bold' : 'normal';
          });
        }

        // Asigna eventos a las pestañas después de agregarlas al DOM
        document.querySelectorAll('.tab-mtto').forEach(tab => {
          tab.onclick = () => mostrarDetalle(Number(tab.dataset.idx));
        });

        // Muestra el primero por defecto
        mostrarDetalle(0);
      })
      .catch(() => {
        document.getElementById('detalle-mantenimiento').innerHTML = '<p>Error al cargar los datos de la máquina.</p>';
      });
    }

    document.addEventListener('DOMContentLoaded', renderHistorial);
  </script>
</body>
</html>
